"use strict";function groupDataByYear(){var a={};return $.each(pubdb,function(b,c){void 0===a[c.year]&&(a[c.year]=[]),a[c.year].push(c)}),$.each(a,function(b,c){var d=[];$.each(c,function(a,b){b.authors.length>1&&$.each(b.authors,function(a,b){d.push(b.name)})});var e=[],f={};$.each(d,function(a,b){-1===$.inArray(b,e)?(e.push(b),f[b]={publications:1,collaborations:1}):(f[b].publications++,f[b].collaborations++)}),a[b].peoplePerYear=e,a[b].stats=f}),a}function drawDiagram(a,b,c){function d(a){return q(a.source.index)}function e(a){return function(b,c){n.selectAll(".chord path").filter(function(b){return(document.getElementById(b.source.index).id==c||document.getElementById(b.target.index).id==c)&&(document.getElementById(b.source.index).nextSibling.firstChild.style.opacity=Math.abs(a-1),document.getElementById(b.target.index).nextSibling.firstChild.style.opacity=Math.abs(a-1),document.getElementById(b.source.index).nextSibling.firstChild.nextSibling.style.opacity=Math.abs(a-1),document.getElementById(b.target.index).nextSibling.firstChild.nextSibling.style.opacity=Math.abs(a-1)),null}),n.selectAll(".chord path").filter(function(a){return a.source.index!==c&&a.target.index!==c}).transition().style("opacity",a)}}function f(a,b){var c=e(.1);c(a,b)}function g(a){t++;var c=(a.endAngle-a.startAngle)/a.value;return d3.range(0,1,1).map(function(d){return{angle:d*c+a.startAngle+(a.endAngle-a.startAngle)/2,label:b[t]}})}var h=d3.tip().attr("class","d3-tip").attr("id",999).offset([0,0]).html(function(a){document.getElementById(999).style.backgroundColor=q(a.index);var c='<strong>Author: </strong><span style="color:red">'+b[a.index]+'</span></br><strong>Publications: </strong><span style="color:red">'+b[a.index]+'</span></br><strong>Collaborations: </strong><span style="color:red">'+b[a.index]+'</span></br><strong>Website: </strong><span style="color:red">'+b[a.index]+"</span>";return c}),i=$(".jumbotron").width(),j=i,k=i,l=.31*k,m=1.1*l,n=d3.select("#viz").append("svg").attr("width",j).attr("height",k).append("g").attr("transform","translate("+j/2+","+k/2+")");$(document).click(function(a){h.hide(a)}),n.call(h);var o,p=d3.layout.chord().matrix(a).sortSubgroups(d3.descending),q=d3.scale.category20c(),r=n.selectAll("g.group").data(p.groups).enter().append("svg:g").attr("class","group").on("click",function(a){a!==o?(d3.select(".d3-tip").transition().delay(100).duration(500).style("opacity",.8),o=a,h.show(a)):o=null}),s=d3.svg.arc().innerRadius(l).outerRadius(m);r.append("path").attr("d",s).style("fill",function(a){return q(a.index)}).style("stroke",function(a){return q(a.index)}).attr("id",function(a){return a.index}),n.append("g").attr("class","chord").selectAll("path").data(p.chords).enter().append("path").attr("d",d3.svg.chord().radius(l)).style("fill",d).style("opacity",1),r.on("mouseover",f).on("mouseout",e(1));var t=-1,u=r.selectAll("g").data(g).enter().append("g").attr("transform",function(a){return"rotate("+(180*a.angle/Math.PI-90)+")translate("+m+",0)"});u.append("text").attr("dx",8).attr("dy",0).attr("opacity",0).attr("transform",function(a){return a.angle>Math.PI?"rotate(180)translate(-16, 0)":null}).style("text-anchor",function(a){return a.angle>Math.PI?"end":null}).text(function(a){return isNaN(a.angle)?null:a.label}),u.append("svg:line").attr("x1",1).attr("y1",0).attr("x2",5).attr("y2",0).attr("opacity",0).attr("stroke","#000"),c()}function redrawDiagramWithFilter(a){void 0===a&&$("#viz").height(viz),d3.select("#viz svg").remove(),$("#fa-spinner").show();var b=yearSlider.slider("getValue"),c=pubSlider.slider("getValue"),d=collabSlider.slider("getValue"),e=getStatisticsForYear(dataByYear[b],c,d);drawDiagram(e,names,function(){$("#fa-spinner").hide(),viz=$("#viz").height()})}function newFilledArray(a,b){for(var c=new Array(a);--a>=0;)c[a]=b;return c}function getStatisticsForYear(a,b,c){for(var d=[],e=0;e<a.peoplePerYear.length;e++)d[e]=newFilledArray(a.peoplePerYear.length,0);return names=new Array(a.peoplePerYear.length),$.each(a,function(e,f){$.each(f.authors,function(e,g){for(var h=e+1;h<f.authors.length;h++){var i=$.inArray(g.name,a.peoplePerYear),j=$.inArray(f.authors[h].name,a.peoplePerYear),k=g.name,l=f.authors[h].name,m=a.stats[k].publications,n=a.stats[l].publications,o=a.stats[k].collaborations,p=a.stats[l].collaborations;m>=b&&n>=n&&o>=c&&p>=c&&(d[i][j]++,d[j][i]++,void 0===names[i]&&(names[i]=k),void 0===names[j]&&(names[j]=l))}})}),d}function redraw(){redrawDiagramWithFilter()}var names,dataByYear,viz;$(document).ready(function(){dataByYear=groupDataByYear(),redrawDiagramWithFilter(),$('[data-toggle="popover"]').popover()});var yearSlider=$("#yearFilter").slider({}),pubSlider=$("#pubFilter").slider({}),collabSlider=$("#collabFilter").slider({});yearSlider.on("slide",redraw),pubSlider.on("slide",redraw),collabSlider.on("slide",redraw),$("#redraw").on("click",redraw),$(window).resize(function(){redrawDiagramWithFilter(!0)});