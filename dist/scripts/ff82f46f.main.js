"use strict";function groupDataByYear(){var a={};return $.each(pubdb,function(b,c){void 0===a[c.year]&&(a[c.year]=[]),a[c.year].push(c)}),$.each(a,function(b,c){var d=[];$.each(c,function(a,b){$.each(b.authors,function(a,b){d.push(b.name)})});var e=[];$.each(d,function(a,b){-1===$.inArray(b,e)&&e.push(b)}),a[b].peoplePerYear=e}),a}function drawDiagram(a,b,c){function d(a){return o(a.source.index)}function e(a){return function(b,c){m.selectAll(".chord path").filter(function(b){return(document.getElementById(b.source.index).id==c||document.getElementById(b.target.index).id==c)&&(document.getElementById(b.source.index).nextSibling.firstChild.style.opacity=Math.abs(a-1),document.getElementById(b.target.index).nextSibling.firstChild.style.opacity=Math.abs(a-1),document.getElementById(b.source.index).nextSibling.firstChild.nextSibling.style.opacity=Math.abs(a-1),document.getElementById(b.target.index).nextSibling.firstChild.nextSibling.style.opacity=Math.abs(a-1)),null}),m.selectAll(".chord path").filter(function(a){return a.source.index!==c&&a.target.index!==c}).transition().style("opacity",a)}}function f(a,b){var c=e(.1);c(a,b)}function g(a){r++;var c=(a.endAngle-a.startAngle)/a.value;return d3.range(0,1,1).map(function(d){return{angle:d*c+a.startAngle+(a.endAngle-a.startAngle)/2,label:b[r]}})}var h=$(".jumbotron").width(),i=h,j=h,k=.31*j,l=1.1*k,m=d3.select("#viz").append("svg").attr("width",i).attr("height",j).append("g").attr("transform","translate("+i/2+","+j/2+")"),n=d3.layout.chord().matrix(a).sortSubgroups(d3.descending),o=d3.scale.category20c(),p=m.selectAll("g.group").data(n.groups).enter().append("svg:g").attr("class","group"),q=d3.svg.arc().innerRadius(k).outerRadius(l);p.append("path").attr("d",q).style("fill",function(a){return o(a.index)}).style("stroke",function(a){return o(a.index)}).attr("id",function(a){return a.index}),m.append("g").attr("class","chord").selectAll("path").data(n.chords).enter().append("path").attr("d",d3.svg.chord().radius(k)).style("fill",d).style("opacity",1),p.on("mouseover",f).on("mouseout",e(1));var r=-1,s=p.selectAll("g").data(g).enter().append("g").attr("transform",function(a){return"rotate("+(180*a.angle/Math.PI-90)+")translate("+l+",0)"});s.append("text").attr("dx",8).attr("dy",0).attr("opacity",0).attr("transform",function(a){return a.angle>Math.PI?"rotate(180)translate(-16, 0)":null}).style("text-anchor",function(a){return a.angle>Math.PI?"end":null}).text(function(a){return isNaN(a.angle)?null:a.label}),s.append("svg:line").attr("x1",1).attr("y1",0).attr("x2",5).attr("y2",0).attr("opacity",0).attr("stroke","#000"),c()}function redrawDiagramWithFilter(a){void 0===a&&$("#viz").height(viz),d3.select("#viz svg").remove(),$("#fa-spinner").show();var b=groupDataByYear(),c=getStatisticsForYear(b[yearslider.slider("getValue")]);drawDiagram(c,names,function(){$("#fa-spinner").hide(),viz=$("#viz").height()})}function getStatisticsForYear(a){function b(a,b){for(var c=new Array(a);--a>=0;)c[a]=b;return c}for(var c=[],d=0;d<a.peoplePerYear.length;d++)c[d]=b(a.peoplePerYear.length,0);return names=new Array(a.peoplePerYear.length),$.each(a,function(b,d){$.each(d.authors,function(b,e){for(var f=b+1;f<d.authors.length;f++){var g=$.inArray(e.name,a.peoplePerYear),h=$.inArray(d.authors[f].name,a.peoplePerYear);c[g][h]++,c[h][g]++,void 0===names[g]&&(names[g]=e.name),void 0===names[h]&&(names[h]=d.authors[f].name)}})}),c}var names,dataByYear,viz;$(document).ready(function(){dataByYear=groupDataByYear(),redrawDiagramWithFilter()}),$(function(){$('[data-toggle="popover"]').popover()});var yearslider=$("#yearFilter").slider({});yearslider.on("slide",function(a){return a.preventDefault(),redrawDiagramWithFilter(),!1}),$("#redraw").on("click",function(){redrawDiagramWithFilter()}),$(window).resize(function(){redrawDiagramWithFilter(!0)});